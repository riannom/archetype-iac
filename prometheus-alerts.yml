# Prometheus Alert Rules for Archetype
#
# These rules define alerting conditions for the Archetype platform.
# Configure Alertmanager to route these alerts to your notification channels.

groups:
  - name: archetype-jobs
    rules:
      # Alert when a job has been running for more than 20 minutes
      - alert: StuckJob
        expr: |
          sum(archetype_jobs_active{job="archetype-api"}) > 0
          and
          (
            (sum(increase(archetype_jobs_total{job=~"archetype-(api|worker)",status=~"completed|failed"}[20m])) or on() vector(0)) == 0
          )
        for: 20m
        labels:
          severity: warning
        annotations:
          summary: "Job stuck for more than 20 minutes"
          description: "A job has been running for over 20 minutes without completing. Check job logs for issues."

      # Alert when job failure rate is high
      - alert: HighJobFailureRate
        expr: |
          (
            sum(rate(archetype_jobs_total{job=~"archetype-(api|worker)",status="failed"}[5m])) /
            sum(rate(archetype_jobs_total{job=~"archetype-(api|worker)"}[5m]))
          ) > 0.3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High job failure rate detected"
          description: "More than 30% of jobs are failing in the last 5 minutes."

      # Alert when worker is executing jobs but key latency metrics are missing
      - alert: JobMetricsCoverageGap
        expr: |
          (
            sum(increase(archetype_jobs_total{job=~"archetype-(api|worker)",status="started"}[2h])) > 0
          )
          and
          (
            (sum(increase(archetype_job_duration_seconds_count{job=~"archetype-(api|worker)"}[2h])) == 0)
            or
            (sum(increase(archetype_job_queue_wait_seconds_count{job=~"archetype-(api|worker)"}[2h])) == 0)
          )
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Job metrics coverage gap detected"
          description: "Worker processed jobs in the last 2h but duration/queue-wait histograms had no samples."

      # Alert when sync activity exists but NLM phase timings are missing
      - alert: NlmMetricsCoverageGap
        expr: |
          (
            sum(increase(archetype_jobs_total{job=~"archetype-(api|worker)",action="sync",status="started"}[2h])) > 0
          )
          and
          (
            sum(increase(archetype_nlm_phase_duration_seconds_count{job=~"archetype-(api|worker)"}[2h])) == 0
          )
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "NLM timing metrics coverage gap detected"
          description: "Sync jobs ran in the last 2h but NLM phase histograms had no samples."

  - name: archetype-agents
    rules:
      # Alert when no agents are online
      - alert: NoHealthyAgents
        expr: archetype_agents_online{job="archetype-api"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "No healthy agents available"
          description: "All agents are offline or unhealthy. Lab operations will fail."

      # Alert when agent is experiencing high CPU
      - alert: AgentHighCPU
        expr: archetype_agent_cpu_percent{job="archetype-api"} > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Agent {{ $labels.host_name }} has high CPU usage"
          description: "Agent CPU usage has been above 90% for 5 minutes."

      # Alert when agent is experiencing high memory usage
      - alert: AgentHighMemory
        expr: archetype_agent_memory_percent{job="archetype-api"} > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Agent {{ $labels.host_name }} has high memory usage"
          description: "Agent memory usage has been above 90% for 5 minutes."

  - name: archetype-enforcement
    rules:
      # Alert when enforcement failure rate is high
      - alert: HighEnforcementFailures
        expr: rate(archetype_enforcement_failures_total{job="archetype-api"}[5m]) > 0.1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High state enforcement failure rate"
          description: "Multiple nodes are exceeding max enforcement retries. Manual intervention may be required."

      # Alert when many nodes have pending enforcement
      - alert: ManyPendingEnforcements
        expr: archetype_enforcement_pending{job="archetype-api"} > 10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Many nodes with pending state enforcement"
          description: "{{ $value }} nodes have mismatched desired/actual states for over 10 minutes."

  - name: archetype-labs
    rules:
      # Alert when labs are stuck in transitional states
      - alert: LabsStuckInTransition
        expr: sum(archetype_labs_total{job="archetype-api",state=~"starting|stopping"}) > 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Labs stuck in transitional state"
          description: "One or more labs have been in a starting/stopping state for over 30 minutes."

      # Alert when many labs are in error state
      - alert: ManyLabsInError
        expr: sum(archetype_labs_total{job="archetype-api",state="error"}) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Multiple labs in error state"
          description: "{{ $value }} labs are in error state."

  - name: archetype-database
    rules:
      # Alert when idle-in-transaction connections accumulate (potential leak)
      - alert: IdleInTransactionConnections
        expr: archetype_db_idle_in_transaction{job="archetype-api"} > 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Idle-in-transaction database connections detected"
          description: "{{ $value }} connections are stuck idle in transaction for over 2 minutes. This may indicate a connection leak that could cause API unresponsiveness."

      # Critical: Many idle-in-transaction connections
      - alert: IdleInTransactionConnectionsCritical
        expr: archetype_db_idle_in_transaction{job="archetype-api"} > 5
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Critical: Multiple idle-in-transaction connections"
          description: "{{ $value }} connections are stuck idle in transaction. API may become unresponsive. PostgreSQL will auto-terminate after 5 minutes."

  - name: archetype-performance
    rules:
      # Alert when node deploy phase P95 is slow
      - alert: SlowNodeDeploy
        expr: histogram_quantile(0.95, sum(rate(archetype_nlm_phase_duration_seconds_bucket{job=~"archetype-(api|worker)",phase="container_deploy",status="success"}[10m])) by (le)) > 120
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Slow node deploy operations"
          description: "P95 container deploy duration exceeds 120 seconds for the last 10 minutes."

      # Alert when container start P95 is very slow
      - alert: SlowBootWait
        expr: histogram_quantile(0.95, sum(rate(archetype_nlm_phase_duration_seconds_bucket{job=~"archetype-(api|worker)",phase="container_start",status="success"}[15m])) by (le)) > 300
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Slow node start times"
          description: "P95 container start duration exceeds 300 seconds for the last 15 minutes."

      # Alert when agent operation errors are high
      - alert: HighAgentOperationErrors
        expr: sum(rate(archetype_agent_node_operation_errors_total[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High agent operation error rate"
          description: "Agent node operation errors exceed 0.5/sec for the last 5 minutes."
